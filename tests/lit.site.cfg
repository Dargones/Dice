# -*- Python -*-

# Configuration file for the 'lit' test runner.
# Most of this file is copied from configurations for:
# https://github.com/dafny-lang/dafny

import os
import sys
import re
import platform
from os import path

import lit.util
import lit.formats

# name: The name of this test suite.
config.name = 'Dice'

config.test_format = lit.formats.ShTest(execute_external=False)

# suffixes: A list of file extensions to treat as test files. This is overriden
# by individual lit.local.cfg files in the test subdirectories.
config.suffixes = ['.roll']

# test_source_root: The root path where tests are located.
config.test_source_root = os.path.dirname(os.path.abspath(__file__))

# repository root
up = os.path.dirname
repositoryRoot = up(
                     up( os.path.abspath(__file__) )
                   )
parserPath = os.path.join(repositoryRoot, 'toplevel.native')
config.substitutions.append( ('%parser', parserPath) )

"""
   Function for quoting filepaths
   so that if they contain spaces
   lit's shell interpreter will
   treat the path as a single argument
"""
def quotePath(path):
    if ' ' in path:
        return '"{path}"'.format(path=path)
    else:
        return path

# Add diff tool substitution
commonDiffFlags=' --unified=3 --strip-trailing-cr'
diffExecutable = None
if os.name == 'posix' or os.name == 'nt':
    pydiff = quotePath( os.path.join(config.test_source_root, 'pydiff.py') )
    diffExecutable = sys.executable + ' ' + pydiff + commonDiffFlags
else:
    lit_config.fatal('Unsupported platform')
lit_config.note("Using diff tool '{}'".format(diffExecutable))

config.substitutions.append( ('%diff', diffExecutable ))